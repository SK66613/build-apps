<!doctype html>
<html lang="ru" data-theme="light">
<head>
  <!-- API is served by the same origin via Worker Route: /api/* -->
  <script>window.API_BASE='';</script>


  
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ¬∑ Mini‚ÄëApp</title>
  <link rel="stylesheet" href="panel.css"/>
</head>
<body>
  <div class="app">
    <aside class="side" id="side">
      <div class="side__top">
        <button class="side__logo" id="homeBtn" title="–ü—Ä–æ–µ–∫—Ç—ã"><img class="sideLogoImg" src="./logo.png" alt="" onerror="this.style.display='none'; this.parentNode.querySelector('.logoMarkFallback').style.display='block';"><span class="logoMark logoMarkFallback" style="display:none">‚óÜ</span></button>
      </div>

      <nav class="side__nav" id="sideNav">
        <button class="side__item" data-view="constructor" title="–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä"><span class="ico">üõ†</span><span class="txt">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</span></button>
        <button class="side__item is-active" data-view="entities" title="–°—É—â–Ω–æ—Å—Ç–∏"><span class="ico">‚óª</span><span class="txt">–°—É—â–Ω–æ—Å—Ç–∏</span></button>
        <button class="side__item" data-view="faq" title="–í–æ–ø—Ä–æ—Å‚Äë–æ—Ç–≤–µ—Ç"><span class="ico">?</span><span class="txt">–í–æ–ø—Ä–æ—Å‚Äë–æ—Ç–≤–µ—Ç</span></button>
        <button class="side__item" data-view="broadcasts" title="–†–∞—Å—Å—ã–ª–∫–∏"><span class="ico">‚û§</span><span class="txt">–†–∞—Å—Å—ã–ª–∫–∏</span></button>
        <button class="side__item" data-view="channels" title="–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è"><span class="ico">‚åÅ</span><span class="txt">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span></button>
        <button class="side__item" data-view="stats" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"><span class="ico">‚ñ¶</span><span class="txt">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></button>
        <button class="side__item" data-view="dialogs" title="–î–∏–∞–ª–æ–≥–∏"><span class="ico">üí¨</span><span class="txt">–î–∏–∞–ª–æ–≥–∏</span></button>
        <div class="side__sep"></div>
        <button class="side__item" data-view="settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><span class="ico">‚öô</span><span class="txt">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
        <button class="side__item" data-view="support" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞"><span class="ico">‚òª</span><span class="txt">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span></button>
        <button class="side__item" data-view="help" title="–°–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä"><span class="ico">‚ìò</span><span class="txt">–°–ø—Ä–∞–≤–æ—á–Ω—ã–π</span></button>
        <button class="side__item" data-view="profile" title="–ü—Ä–æ—Ñ–∏–ª—å"><span class="ico">‚ò∫</span><span class="txt">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
      </nav>

      <div class="side__bottom">
        <button class="themeSwitch" id="themeSwitch" type="button" title="–¢–µ–º–∞">
          <span class="ts-ico ts-moon">‚òæ</span>
          <span class="ts-ico ts-sun">‚òÄ</span>
          <span class="ts-knob" aria-hidden="true"></span>
        </button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="crumb"><span class="crumb__chev">‚Ä∫</span><span class="crumb__name" id="projectName">–ë–ò–ó–ù–ï–° –ö–í–ï–°–¢</span>
          <select id="appSwitchGlobal" class="appSwitch" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"></select></div>
        <div class="topbar__right"><button class="btn" id="logoutGlobalBtn">–í—ã–π—Ç–∏</button><button class="btn btn--danger" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞</button></div>
      </header>

      <section class="page">
        <div class="page__hdr" id="pageHdr">
          <h1 id="pageTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h1>
          <div class="page__sub" id="pageSub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é.</div>
        </div>

        <div class="tabs" id="settingsTabs" hidden>
          <button class="tab is-active" data-tab="base">–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="tab" data-tab="fallbacks">–û—Ç–≤–µ—Ç—ã –ø—Ä–∏ —Ñ–æ—Ä—Å‚Äë–º–∞–∂–æ—Ä–∞—Ö</button>
          <button class="tab" data-tab="integrations">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</button>
        </div>

        <div class="views">
          <section class="view" data-view="constructor">
            <div class="ctorWrap">
              <!-- embed=1: seamless mode inside work panel
                   host_side_w: fixed main menu width (see --side-w in panel.css) -->
              <iframe class="ctorFrame" id="ctorFrame" title="–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä mini-app" src="miniapp_sections_fixed2/app/index.html?embed=1&host_side_w=96px"></iframe>
            </div>
          </section>

          <section class="view is-show" data-view="entities">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">–°—É—â–Ω–æ—Å—Ç–∏</div>
                  <div class="card__sub">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π mini‚Äëapp: —Ç–æ–≤–∞—Ä—ã, —É—Å–ª—É–≥–∏, –∏–≥—Ä—ã, —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</div>
                </div>
                <button class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
              <div class="tableWrap">
                <table class="table">
                  <thead><tr><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead>
                  <tbody>
                    <tr><td>–°—Ç—Ä–∞–Ω–∏—Ü–∞</td><td>–ì–ª–∞–≤–Ω–∞—è</td><td><span class="pill pill--ok">–∞–∫—Ç–∏–≤–Ω–∞</span></td><td class="tr">‚ãØ</td></tr>
                    <tr><td>–ò–≥—Ä–∞</td><td>–ö–æ–ª–µ—Å–æ</td><td><span class="pill">—á–µ—Ä–Ω–æ–≤–∏–∫</span></td><td class="tr">‚ãØ</td></tr>
                    <tr><td>–ü—Ä–æ–º–æ</td><td>–°–∫–∏–¥–∫–∞ 10%</td><td><span class="pill pill--ok">–∞–∫—Ç–∏–≤–Ω–∞</span></td><td class="tr">‚ãØ</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="view" data-view="faq">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">FAQ</div>
                  <div class="card__sub">–û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –±–æ—Ç–µ.</div>
                </div>
                <button class="btn">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
              </div>
              <div class="empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å‚Äë–æ—Ç–≤–µ—Ç.</div>
            </div>
          </section>

<section class="view" data-view="broadcasts">
  <div class="card">
    <div class="card__hdr">
      <div>
        <div class="card__title">–†–∞—Å—Å—ã–ª–∫–∏</div>
        <div class="card__sub">–°–æ–∑–¥–∞–π –∫–∞–º–ø–∞–Ω–∏—é –∏ –æ—Ç–ø—Ä–∞–≤—å –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É.</div>
      </div>
      <div class="actions">
        <button class="btn" id="bcReloadBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn--primary" id="bcNewBtn">–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</button>
      </div>
    </div>

    <div class="grid2" style="align-items:start">
      <!-- composer -->
      <div class="bcComposer" id="bcComposer" hidden>
        <div class="form">
          <div class="field">
            <span>–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–ª—è —Ç–µ–±—è)</span>
            <input class="input" id="bcTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–∏–¥–∫–∞ 10% –¥–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è"/>
          </div>

          <div class="field">
            <span>–°–µ–≥–º–µ–Ω—Ç</span>
            <select class="input" id="bcSegment">
              <option value="bot_active">–ó–∞–ø—É—Å–∫–∞–ª–∏ –±–æ—Ç–∞</option>
              <option value="all">–í—Å–µ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ)</option>
              <option value="mini_active_7d">–û—Ç–∫—Ä—ã–≤–∞–ª–∏ mini-app –∑–∞ 7 –¥–Ω–µ–π</option>
              <option value="inactive_7d">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ 7 –¥–Ω–µ–π</option>
            </select>
          </div>

          <div class="field">
            <span>–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ <span class="req">*</span></span>
            <textarea class="textarea" id="bcText" rows="6" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea>
            <div class="mut">HTML —Ä–∞–∑—Ä–µ—à—ë–Ω (parse_mode=HTML). –°—Å—ã–ª–∫–∏ –ª—É—á—à–µ –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ.</div>
          </div>

          <div class="field">
            <span>–ö–Ω–æ–ø–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
            <div class="grid2">
              <input class="input" id="bcBtnText" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏"/>
              <input class="input" id="bcBtnUrl" placeholder="https://..."/>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="bcCancelBtn">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn--primary" id="bcSendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <span class="mut" id="bcStatus"></span>
          </div>
        </div>
      </div>

      <!-- list -->
      <div>
        <div class="tableWrap">
          <table class="table" id="bcTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–°–µ–≥–º–µ–Ω—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th class="tr">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
              </tr>
            </thead>
            <tbody id="bcTbody">
              <tr><td colspan="5" class="mut">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚Äú–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞‚Äù.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mut" style="margin-top:10px">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –±–∞–∑—É –∫–∞–∫ –∏–∑ mini-app, —Ç–∞–∫ –∏ –∏–∑ –±–æ—Ç–∞ (—Ç–∞–±–ª–∏—Ü–∞ app_users).
        </div>
      </div>
    </div>
  </div>
</section>


          <section class="view" data-view="channels">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤</div>
                  <div class="card__sub">Telegram, Webhook, CRM, –∫–∞—Å—Å–∞, Google Sheets.</div>
                </div>
                <button class="btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
              </div>
              <div class="grid2">
                <div class="miniCard"><div class="miniCard__t">Telegram Bot API</div><div class="miniCard__s">–¢–æ–∫–µ–Ω, WebApp, –∫–æ–º–∞–Ω–¥—ã</div></div>
                <div class="miniCard"><div class="miniCard__t">Webhook</div><div class="miniCard__s">URL –∏ —Ç–µ—Å—Ç–æ–≤—ã–π URL</div></div>
              </div>
            </div>
          </section>

          <section class="view" data-view="stats">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                  <div class="card__sub">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≤—ã—Ä—É—á–∫–∞.</div>
                </div>
                <div class="chips">
                  <button class="chip is-on">30 –¥–Ω–µ–π</button>
                  <button class="chip">7 –¥–Ω–µ–π</button>
                  <button class="chip">–°–µ–≥–æ–¥–Ω—è</button>
                </div>
              </div>
              <div class="grid3">
                <div class="kpi"><div class="kpi__l">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div><div class="kpi__v">1 284</div><div class="kpi__d">+6%</div></div>
                <div class="kpi"><div class="kpi__l">–ß–µ–∫–∏</div><div class="kpi__v">312</div><div class="kpi__d">+12%</div></div>
                <div class="kpi"><div class="kpi__l">–í—ã—Ä—É—á–∫–∞</div><div class="kpi__v">124 500 ‚ÇΩ</div><div class="kpi__d">+18%</div></div>
              </div>
              <div class="ph">–ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ (API).</div>
            </div>
          </section>

<section class="view" data-view="dialogs">
  <div class="card">
    <div class="card__hdr card__hdr--split">
      <div>
        <div class="card__title">–î–∏–∞–ª–æ–≥–∏</div>
        <div class="card__sub">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π Telegram-–±–æ—Ç–∞ –∏ –æ—Ç–≤–µ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.</div>
      </div>
      <div class="actions">
        <button class="btn" id="dlgReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="dlgLayout">
      <!-- left: users -->
      <div class="dlgLeft">
        <div class="dlgSearch">
          <input class="input" id="dlgSearch" placeholder="–ü–æ–∏—Å–∫: @username –∏–ª–∏ ID">
        </div>
        <div class="dlgUsers" id="dlgUsers">
          <div class="mut">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        </div>
      </div>

      <!-- right: chat -->
      <div class="dlgRight">
        <div class="dlgTop" id="dlgTop">
          <div class="mut">–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ª–µ–≤–∞</div>
        </div>

        <div class="dlgChat" id="dlgChat"></div>

        <div class="dlgSend">
          <textarea class="textarea" id="dlgText" rows="2" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é‚Ä¶"></textarea>
          <button class="btn btn--primary" id="dlgSendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="mut" id="dlgStatus" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</section>


          <section class="view" data-view="settings">
            <div class="stack">
              <div class="card">
                <div class="card__hdr">
                  <div>
                    <div class="card__title">–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <div class="card__sub">–ù–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—É–±–ª–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</div>
                  </div>
                </div>
                <div class="form">
                  <label class="field">
                    <span>–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞<span class="req">*</span></span>
                    <div class="field__row">
                      <input class="input" id="botTitle" placeholder="–ë–∏–∑–Ω–µ—Å –∫–≤–µ—Å—Ç" value="–ë–∏–∑–Ω–µ—Å –∫–≤–µ—Å—Ç"/>
                      <button class="iconBtn" type="button" title="–û—á–∏—Å—Ç–∏—Ç—å" id="clearTitle">√ó</button>
                    </div>
                  </label>

                  <div class="actions">
                    <button class="btn btn--primary" id="saveBase">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <span class="mut" id="saveHint"></span>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__hdr">
                  <div>
                    <div class="card__title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞</div>
                    <div class="card__sub">URL –¥–ª—è –±–æ–µ–≤–æ–≥–æ –∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞.</div>
                  </div>
                  <span class="info">?</span>
                </div>
                <div class="form">
                  <label class="field"><span>URL –≤–∞—à–µ–≥–æ –≤–µ–±—Ö—É–∫–∞</span><input class="input" placeholder="https://..."/></label>
                  <label class="field"><span>URL —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞</span><input class="input" placeholder="https://..."/></label>
                  <div class="mut">–¢–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –≤–∏–¥–∂–µ—Ç–µ.</div>
                  <div class="actions"><button class="btn btn--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                </div>
              </div>

              <div class="card" id="tab_integrations" hidden>
                <div class="card__hdr card__hdr--split">
                  <div>
                    <div class="card__title">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
                    <div class="card__sub">
                      –ü–æ–¥–∫–ª—é—á–∏ Telegram-–±–æ—Ç–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –∏ –∫—ç—à–±—ç–∫–∞.
                    </div>
                  </div>
                  <span class="pill" id="botStatusBadge">–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</span>
                </div>

                <div class="form">
                  <label class="field">
                    <span>–ò–º—è –±–æ—Ç–∞ <span class="mut">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></span>
                    <input class="input" id="botUsername" placeholder="@my_loyalty_bot">
                  </label>

                  <label class="field">
                    <span>–¢–æ–∫–µ–Ω –±–æ—Ç–∞</span>
                    <input
                      class="input"
                      id="botToken"
                      type="password"
                      autocomplete="off"
                      placeholder="123456:ABC-DEF..."
                    >
                    <div class="mut">
                      –¢–æ–∫–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –≤ –Ω–∞—à–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ.
                    </div>
                  </label>

                  <div class="actions">
                    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
                    <button
                      class="btn btn--primary"
                      id="saveBotIntegration"
                      style="width:100%;"
                    >
                      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
                    </button>
                  </div>

                  <div class="mut" id="botSaveHint"></div>
                </div>
              </div>

            </div>
          </section>

          <section class="view" data-view="support">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                  <div class="card__sub">–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏ —Å—Ç–∞—Ç—É—Å—ã –∑–∞—è–≤–æ–∫.</div>
                </div>
              </div>
              <div class="empty">–ù–∞–ø–∏—à–∏ –Ω–∞–º ‚Äî –æ—Ç–≤–µ—á–∞–µ–º –±—ã—Å—Ç—Ä–æ.</div>
            </div>
          </section>

          <section class="view" data-view="help">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">–°–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä</div>
                  <div class="card__sub">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –≥–∞–π–¥—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.</div>
                </div>
              </div>
              <div class="empty">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</div>
            </div>
          </section>

          <section class="view" data-view="profile">
            <div class="card">
              <div class="card__hdr">
                <div>
                  <div class="card__title">–ü—Ä–æ—Ñ–∏–ª—å</div>
                  <div class="card__sub">–ê–∫–∫–∞—É–Ω—Ç, –¥–æ—Å—Ç—É–ø—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</div>
                </div>
              </div>
              <div class="empty">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</div>
            </div>
          </section>
        </div>
      </section>

      <button class="chatFab" title="–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏">üí¨</button>
    </main>
  </div>

  <script src="panel_shell.js"></script>
  <script src="panel.js"></script>


  <script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function getAppId(){
    // —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å ?app=two –≤ URL
    const u = new URL(location.href);
    const q = u.searchParams.get('app');
    if (q) return q;
    // fallback: –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä
    const sel = $('appSwitchGlobal');
    return sel && sel.value ? sel.value : '';
  }

  async function api(path, opts={}){
    const res = await fetch(path, {
      credentials:'include',
      ...opts,
      headers: { 'content-type':'application/json', ...(opts.headers||{}) }
    });
    const j = await res.json().catch(()=>null);
    if (!res.ok) throw new Error((j && (j.error||j.message)) || ('HTTP_'+res.status));
    return j;
  }

  function renderList(items){
    const tb = $('bcTbody');
    if (!tb) return;
    if (!items || !items.length){
      tb.innerHTML = '<tr><td colspan="5" class="mut">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚Äú–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞‚Äù.</td></tr>';
      return;
    }
    tb.innerHTML = items.map(it=>{
      const title = (it.title || '').trim() || '‚Äî';
      const seg = it.segment || '‚Äî';
      const st  = it.status || '‚Äî';
      const res = `${it.sent||0}/${it.total||0} (fail:${it.failed||0}, blk:${it.blocked||0})`;
      return `
        <tr>
          <td>${it.id}</td>
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(seg)}</td>
          <td><span class="pill ${st==='done' ? 'pill--ok':''}">${escapeHtml(st)}</span></td>
          <td class="tr">${escapeHtml(res)}</td>
        </tr>`;
    }).join('');
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  async function loadBroadcasts(){
    const appId = getAppId();
    if (!appId) return;
    const j = await api(`/api/app/${encodeURIComponent(appId)}/broadcasts`, { method:'GET' });
    renderList(j.items || []);
  }

  function openComposer(on){
    const box = $('bcComposer');
    if (!box) return;
    box.hidden = !on;
    $('bcStatus').textContent = '';
    if (on) $('bcText').focus();
  }

  async function sendBroadcast(){
    const appId = getAppId();
    if (!appId) return;

    const title = $('bcTitle').value || '';
    const segment = $('bcSegment').value || 'bot_active';
    const text = $('bcText').value || '';
    const btn_text = $('bcBtnText').value || '';
    const btn_url  = $('bcBtnUrl').value || '';

    if (!text.trim()){
      $('bcStatus').textContent = '–ù—É–∂–µ–Ω —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏.';
      return;
    }

    $('bcSendBtn').disabled = true;
    $('bcStatus').textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶';

    try{
      const j = await api(`/api/app/${encodeURIComponent(appId)}/broadcast`, {
        method:'POST',
        body: JSON.stringify({
          title, segment, text,
          btn_text: btn_text.trim() || null,
          btn_url: btn_url.trim() || null
        })
      });

      $('bcStatus').textContent = `–ì–æ—Ç–æ–≤–æ: sent ${j.sent}/${j.total}, fail ${j.failed}, blocked ${j.blocked}`;
      openComposer(false);
      await loadBroadcasts();
    }catch(e){
      $('bcStatus').textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e);
    }finally{
      $('bcSendBtn').disabled = false;
    }
  }

  // bind
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'bcNewBtn') openComposer(true);
    if (e.target && e.target.id === 'bcCancelBtn') openComposer(false);
    if (e.target && e.target.id === 'bcSendBtn') sendBroadcast();
    if (e.target && e.target.id === 'bcReloadBtn') loadBroadcasts();
  });

  // –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å view broadcasts ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º
  // (–≤ –ø–∞–Ω–µ–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å–≤–æ—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è, –Ω–æ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
  window.addEventListener('focus', loadBroadcasts);

  // –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ ‚Äî —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–º
  const sel = $('appSwitchGlobal');
  if (sel) sel.addEventListener('change', ()=>setTimeout(loadBroadcasts, 50));

  // —Å—Ç–∞—Ä—Ç
  setTimeout(loadBroadcasts, 200);
})();
</script>

  <script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function getAppId(){
    const u = new URL(location.href);
    const q = u.searchParams.get('app');
    if (q) return q;
    const sel = $('appSwitchGlobal');
    return sel && sel.value ? sel.value : '';
  }

  async function api(path, opts={}){
    const res = await fetch(path, {
      credentials:'include',
      ...opts,
      headers:{ 'content-type':'application/json', ...(opts.headers||{}) }
    });
    const j = await res.json().catch(()=>null);
    if (!res.ok) throw new Error((j && (j.error||j.message)) || ('HTTP_'+res.status));
    return j;
  }

  function esc(s){
    return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  let dlgUsers = [];
  let activeUserId = null;

  function renderUsers(list){
    const box = $('dlgUsers');
    if (!box) return;

    if (!list || !list.length){
      box.innerHTML = '<div class="mut">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É /start).</div>';
      return;
    }

    box.innerHTML = list.map(u=>{
      const name = u.tg_username ? '@'+u.tg_username : ('ID ' + u.tg_user_id);
      const meta = `${u.tg_user_id} ¬∑ in:${u.in_count||0} out:${u.out_count||0}`;
      const last = u.last_text ? (u.last_dir === 'out' ? '–í—ã: ' : '–û–Ω: ') + u.last_text : '';
      const active = String(u.tg_user_id) === String(activeUserId) ? 'active' : '';
      return `
        <div class="dlgUser ${active}" data-uid="${esc(u.tg_user_id)}">
          <div style="flex:1; min-width:0">
            <div class="dlgUName">${esc(name)}</div>
            <div class="dlgUMeta">${esc(meta)}</div>
            <div class="dlgULast">${esc(last)}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderTop(u){
    const top = $('dlgTop');
    if (!top) return;
    const name = u.tg_username ? '@'+u.tg_username : '–ë–µ–∑ username';
    top.innerHTML = `
      <div>
        <div style="font-weight:800">${esc(name)}</div>
        <div class="mut">ID: ${esc(u.tg_user_id)}</div>
      </div>
      <div class="mut">${esc(u.bot_last_seen || '')}</div>
    `;
  }

  function renderMsgs(items){
    const chat = $('dlgChat');
    if (!chat) return;

    if (!items || !items.length){
      chat.innerHTML = '<div class="mut">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
      return;
    }

    chat.innerHTML = items.map(m=>{
      const dir = m.direction === 'out' ? 'out' : 'in';
      const txt = m.text || '';
      const time = m.created_at || '';
      return `
        <div class="msgRow ${dir –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è}">
      `;
    }).join('');
  }

  // –º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–∞–≤–∫–∞: dir –≤ template
  function renderMsgs(items){
    const chat = $('dlgChat');
    if (!chat) return;

    if (!items || !items.length){
      chat.innerHTML = '<div class="mut">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
      return;
    }

    chat.innerHTML = items.map(m=>{
      const dir = (m.direction === 'out') ? 'out' : 'in';
      const txt = m.text || '';
      const time = m.created_at || '';
      return `
        <div class="msgRow ${dir}">
          <div>
            <div class="msgBubble">${esc(txt)}</div>
            <div class="msgTime">${esc(time)}</div>
          </div>
        </div>
      `;
    }).join('');

    chat.scrollTop = chat.scrollHeight;
  }

  async function loadUsers(){
    const appId = getAppId();
    if (!appId) return;

    $('dlgStatus').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤‚Ä¶';
    const j = await api(`/api/app/${encodeURIComponent(appId)}/dialogs`, { method:'GET' });
    dlgUsers = j.items || [];
    $('dlgStatus').textContent = '';
    applySearch();
  }

  function applySearch(){
    const q = String(($('dlgSearch')?.value || '')).trim().toLowerCase();
    const list = !q ? dlgUsers : dlgUsers.filter(u=>{
      const a = String(u.tg_user_id||'').toLowerCase();
      const b = String(u.tg_username||'').toLowerCase();
      return a.includes(q) || b.includes(q) || ('@'+b).includes(q);
    });
    renderUsers(list);
  }

  async function openDialog(tgUserId){
    activeUserId = String(tgUserId);
    $('dlgSendBtn').disabled = false;

    const u = dlgUsers.find(x => String(x.tg_user_id) === String(activeUserId));
    if (u) renderTop(u);

    renderUsers((String(($('dlgSearch')?.value||'')).trim() ? dlgUsers.filter(()=>true) : dlgUsers));

    const appId = getAppId();
    const j = await api(`/api/app/${encodeURIComponent(appId)}/dialog/${encodeURIComponent(activeUserId)}?limit=120`, { method:'GET' });
    renderMsgs(j.items || []);
  }

  async function sendMsg(){
    const textEl = $('dlgText');
    const btn = $('dlgSendBtn');

    const text = String(textEl.value || '').trim();
    if (!text) return;

    if (!activeUserId){
      $('dlgStatus').textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ª–µ–≤–∞.';
      return;
    }

    btn.disabled = true;
    $('dlgStatus').textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶';

    try{
      const appId = getAppId();
      await api(`/api/app/${encodeURIComponent(appId)}/dialog/${encodeURIComponent(activeUserId)}`, {
        method:'POST',
        body: JSON.stringify({ text })
      });
      textEl.value = '';
      $('dlgStatus').textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ';

      // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–ø–∏—Å–æ–∫ (—á—Ç–æ–±—ã last_text –æ–±–Ω–æ–≤–∏–ª—Å—è)
      await openDialog(activeUserId);
      await loadUsers();
    } catch(e){
      $('dlgStatus').textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e);
    } finally {
      btn.disabled = false;
      setTimeout(()=>{ if ($('dlgStatus').textContent === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ') $('dlgStatus').textContent = ''; }, 2000);
    }
  }

  // events
  document.addEventListener('click', (e)=>{
    const card = e.target.closest('.dlgUser');
    if (card && card.dataset.uid) openDialog(card.dataset.uid);

    if (e.target && e.target.id === 'dlgReload') loadUsers();
    if (e.target && e.target.id === 'dlgSendBtn') sendMsg();
  });

  document.addEventListener('input', (e)=>{
    if (e.target && e.target.id === 'dlgSearch') applySearch();
    if (e.target && e.target.id === 'dlgText') $('dlgSendBtn').disabled = !String($('dlgText').value||'').trim() || !activeUserId;
  });

  document.addEventListener('keydown', (e)=>{
    if (e.target && e.target.id === 'dlgText'){
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        sendMsg();
      }
    }
  });

  // –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—à—å –ø—Ä–æ–µ–∫—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
  const sel = $('appSwitchGlobal');
  if (sel) sel.addEventListener('change', ()=>setTimeout(()=>{ activeUserId=null; $('dlgSendBtn').disabled=true; loadUsers(); }, 50));

  // –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
  setTimeout(loadUsers, 300);
})();
</script>


</body>
</html>
